<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICI App</title>
</head>
<body>
    <h1>ICI 2.5</h1>
    <p id="app-description">This app is designed to demonstrate continuous integration and deployment.</p>
    <p>Data from server: <span id="data-from-server"></span></p>
    <textarea id="env-box" style="width:100%;height:80px;" placeholder="Shared for all clients with the same env-id"></textarea>
    <br>
    <textarea id="client-box" style="width:100%;height:40px;" placeholder="Shared for all with the same public IP and env-id"></textarea>
    <br>
    <textarea id="private-box" style="width:100%;height:40px;" placeholder="Private for this browser and env-id"></textarea>
    <br>
    <button id="save-btn">Save Changes</button>
    {% if env_id is defined %}
    <script type="text/javascript">
      window.env_id_from_server = "{{ env_id }}";
    </script>
    {% endif %}
    <script>
    // Fetch public IP using a public API
    function fetchPublicIp() {
        return fetch('https://api.ipify.org?format=json').then(r => r.json()).then(d => d.ip);
    }
    // Use env_id from server if available, otherwise fetch
    var envIdFromServer = window.env_id_from_server || null;
    function fetchEnvId() {
        if (envIdFromServer) {
            return Promise.resolve(envIdFromServer);
        }
        return fetch('/env-id').then(r => r.json()).then(d => d.env_id);
    }
    // Generate or retrieve a persistent private client ID for this env-id
    function getPrivateClientId(envId) {
        const storageKey = 'private-client-id-' + envId;
        let clientId = localStorage.getItem(storageKey);
        if (!clientId) {
            clientId = Math.random().toString(16).slice(2) + Date.now().toString(16);
            localStorage.setItem(storageKey, clientId);
        }
        return clientId;
    }
    // Key helpers
    function getEnvBoxKey(envId) {
        return 'env-box-' + envId;
    }
    function getClientBoxKey(envId, publicIp) {
        return 'client-box-' + envId + '-' + publicIp;
    }
    function getPrivateBoxKey(envId, privateClientId) {
        return 'private-box-' + envId + '-' + privateClientId;
    }
    Promise.all([fetchEnvId(), fetchPublicIp()]).then(([envId, publicIp]) => {
        const privateClientId = getPrivateClientId(envId);
        // Set up env-box (shared across all clients with same env-id)
        const envBox = document.getElementById('env-box');
        function loadEnvBox() {
            fetch('/env-box').then(r => r.json()).then(d => {
                envBox.value = (d.value !== undefined && d.value !== null && d.value !== "") ? d.value : envId;
                // Sync all textboxes with the same env-id
                document.querySelectorAll('#env-box').forEach(box => { box.value = envBox.value; });
            });
        }
        loadEnvBox();
        // Save env-box on Save button click
        document.getElementById('save-btn').addEventListener('click', function() {
            fetch('/env-box', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({value: envBox.value})
            }).then(() => loadEnvBox());
            // Save client-box to localStorage
            const clientBox = document.getElementById('client-box');
            const clientBoxKey = getClientBoxKey(envId, publicIp);
            localStorage.setItem(clientBoxKey, clientBox.value);
            // Save private-box to localStorage
            const privateBox = document.getElementById('private-box');
            const privateBoxKey = getPrivateBoxKey(envId, privateClientId);
            localStorage.setItem(privateBoxKey, privateBox.value);
        });
        // Set up client-box (shared for all with same public IP and env-id)
        const clientBox = document.getElementById('client-box');
        const clientBoxKey = getClientBoxKey(envId, publicIp);
        let clientBoxValue = localStorage.getItem(clientBoxKey);
        clientBox.value = (clientBoxValue !== undefined && clientBoxValue !== null && clientBoxValue !== "") ? clientBoxValue : publicIp;
        // Set up private-box (private to this browser and env-id)
        const privateBox = document.getElementById('private-box');
        const privateBoxKey = getPrivateBoxKey(envId, privateClientId);
        let privateBoxValue = localStorage.getItem(privateBoxKey);
        privateBox.value = (privateBoxValue !== undefined && privateBoxValue !== null && privateBoxValue !== "") ? privateBoxValue : privateClientId;
        // Optionally, keep env-box updated from server
        setInterval(loadEnvBox, 2000);
    });
    </script>
</body>
</html>
